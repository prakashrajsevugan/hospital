<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Emergency System</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header>
    <div class="header-content">
        <h1>Hospital Emergency Management System</h1>
        <div class="user-info">
            <span class="user-badge">ğŸ‘¤ {{ username }} ({{ role }})</span>
            <a href="/logout" class="logout-btn">ğŸšª Logout</a>
        </div>
    </div>
    <div class="stats-bar" id="statsBar">
        <span>ğŸ‘¥ <span id="totalPatients">0</span> Patients</span>
        <span>â±ï¸ <span id="queueLength">0</span> in Queue</span>
        <span>ğŸš¨ <span id="totalIncidents">0</span> Incidents</span>
        <span>ğŸ—ºï¸ <span id="totalRoutes">0</span> Routes</span>
    </div>
</header>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
    {% for category, message in messages %}
      <div class="flash flash-{{ category }}">
        {{ message }}
        <button class="flash-close" onclick="this.parentElement.remove()">Ã—</button>
      </div>
    {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<main>

    <!-- Patient Records -->
    <section class="card">
        <h2>ğŸ“‹ Patient Records (Linked List)</h2>
        <div class="card-actions">
            <input type="text" id="searchPatients" placeholder="ğŸ” Search patients..." onkeyup="searchTable('searchPatients', 'patientList')">
            <a href="/export/patients" class="export-btn" title="Export to CSV">ğŸ“¥ Export</a>
        </div>
        <form action="/add_patient" method="POST">
            <input type="number" name="id" placeholder="Patient ID" required>
            <input type="text" name="name" placeholder="Patient Name" required>
            <button>â• Add Patient</button>
        </form>

        <div class="display-area" id="patientList">
            {% if patients %}
            {% for p in patients %}
                <div class="item-with-delete searchable-item">
                    <span>ğŸ¥ ID: {{p[0]}} - {{p[1]}}</span>
                    <a href="/delete_patient/{{p[0]}}" class="delete-btn" onclick="return confirm('Delete patient {{p[1]}}?')">ğŸ—‘ï¸</a>
                </div>
            {% endfor %}
            {% else %}
            <p>No records yet.</p>
            {% endif %}
        </div>
    </section>

    <!-- Queue -->
    <section class="card">
        <h2>â±ï¸ Patient Queue</h2>
        <div class="card-actions">
            <a href="/export/queue" class="export-btn" title="Export to CSV">ğŸ“¥ Export</a>
        </div>
        <form action="/add_queue" method="POST">
            <input type="text" name="name" placeholder="Patient Name" required>
            <button>â• Add to Queue</button>
        </form>
        <a href="/process_queue"><button class="act-btn">â–¶ï¸ Process Next</button></a>

        <div class="display-area">
            {% if queue %}
            {% for q in queue %}
                <p>ğŸ‘¤ {{q}}</p>
            {% endfor %}
            {% else %}
            <p>No requests.</p>
            {% endif %}
        </div>
    </section>

    <!-- Stack -->
    <section class="card">
        <h2>ğŸš¨ Incident Log (Stack)</h2>
        <form action="/add_incident" method="POST">
            <input type="text" name="incident" placeholder="Incident Detail" required>
            <button>ğŸ“ Log Incident</button>
        </form>
        <a href="/undo_incident"><button class="act-btn">â†©ï¸ Undo Last</button></a>

        <div class="display-area">
            {% if incidents %}
            {% for i in incidents %}
                <p>âš ï¸ {{i}}</p>
            {% endfor %}
            {% else %}
            <p>No incidents.</p>
            {% endif %}
        </div>
    </section>

    <!-- Tree -->
    <section class="card">
        <h2>ğŸ¢ Hospital Hierarchy (Tree)</h2>
        <div class="display-area">
            <div class="hierarchy-tree">
                <div class="tree-node">
                    <strong>ğŸ‘” Hospital Director</strong>
                    <div class="departments">
                        {% for dept, staff_list in hierarchy["Hospital Director"]["departments"].items() %}
                        <div class="department">
                            <div class="dept-header" onclick="toggleDept('{{dept}}')">
                                <span class="dept-name">ï¿½â€âš•ï¸ {{dept}} ({{staff_list|length}})</span>
                                <span class="toggle-icon" id="icon-{{dept}}">â–¼</span>
                            </div>
                            <div class="dept-content" id="dept-{{dept}}">
                                <form action="/add_staff" method="POST" class="add-staff-form">
                                    <input type="hidden" name="department" value="{{dept}}">
                                    <input type="text" name="staff_name" placeholder="Add staff member" required>
                                    <button>â• Add</button>
                                </form>
                                <div class="staff-list">
                                    {% if staff_list %}
                                        {% for staff in staff_list %}
                                        <div class="staff-item-with-delete">
                                            <span>ğŸ‘¤ {{staff}}</span>
                                            <a href="/delete_staff/{{dept}}/{{staff}}" class="delete-btn-small" onclick="return confirm('Delete {{staff}} from {{dept}}?')">ğŸ—‘ï¸</a>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="staff-item">No staff added yet</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Graph -->
    <section class="card">
        <h2>ğŸ—ºï¸ City Map (Graph)</h2>
        <form action="/add_route" method="POST">
            <input name="city_a" placeholder="City A" required>
            <input name="city_b" placeholder="City B" required>
            <button>ğŸ›£ï¸ Add Route</button>
        </form>

        <div class="display-area">
            {% if graph %}
            {% for city, routes in graph.items() %}
                {% for route in routes %}
                <div class="item-with-delete">
                    <span>ğŸ“ {{city}} â†” {{route}}</span>
                    <a href="/delete_route/{{city}}/{{route}}" class="delete-btn" onclick="return confirm('Delete route between {{city}} and {{route}}?')">ğŸ—‘ï¸</a>
                </div>
                {% endfor %}
            {% endfor %}
            {% else %}
            <p>No routes.</p>
            {% endif %}
        </div>
    </section>

    <!-- Hash -->
    <section class="card">
        <h2>ğŸ” Emergency ID Lookup (Hash)</h2>
        <div class="card-actions">
            <input type="text" id="searchEmergency" placeholder="ğŸ” Search by ID or name..." onkeyup="searchTable('searchEmergency', 'emergencyList')">
            <a href="/export/emergency" class="export-btn" title="Export to CSV">ğŸ“¥ Export</a>
        </div>
        <form action="/add_hash" method="POST">
            <input type="number" name="pid" placeholder="Emergency ID" required>
            <input type="text" name="name" placeholder="Patient Name" required>
            <button>ğŸ’¾ Store</button>
        </form>

        <form action="/search_hash" method="POST">
            <input type="number" name="pid" placeholder="Search ID" required>
            <button>ğŸ” Search</button>
        </form>

        <div class="display-area" id="emergencyList">
            {% set has_data = false %}
            {% for bucket in hash_data %}
                {% if bucket %}
                    {% set has_data = true %}
                    {% for pid, name in bucket %}
                        <div class="item-with-delete searchable-item">
                            <span>ğŸ†” ID: {{pid}} â†’ {{name}}</span>
                            <a href="/delete_hash/{{pid}}" class="delete-btn" onclick="return confirm('Delete emergency ID {{pid}} ({{name}})?')">ğŸ—‘ï¸</a>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endfor %}
            {% if not has_data %}
                <p>No emergency records stored yet.</p>
            {% endif %}
        </div>
    </section>

</main>

<footer>
    <p>Â© 2025 Hospital Emergency System</p>
</footer>

<script>
function toggleDept(dept) {
    const content = document.getElementById('dept-' + dept);
    const icon = document.getElementById('icon-' + dept);
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        icon.textContent = 'â–²';
    } else {
        content.style.display = 'none';
        icon.textContent = 'â–¼';
    }
}

// Search functionality
function searchTable(inputId, containerId) {
    const input = document.getElementById(inputId);
    const filter = input.value.toUpperCase();
    const container = document.getElementById(containerId);
    const items = container.getElementsByClassName('searchable-item');
    
    for (let i = 0; i < items.length; i++) {
        const text = items[i].textContent || items[i].innerText;
        if (text.toUpperCase().indexOf(filter) > -1) {
            items[i].style.display = '';
        } else {
            items[i].style.display = 'none';
        }
    }
}

// Load statistics
function loadStats() {
    fetch('/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalPatients').textContent = data.total_patients;
            document.getElementById('queueLength').textContent = data.queue_length;
            document.getElementById('totalIncidents').textContent = data.total_incidents;
            document.getElementById('totalRoutes').textContent = data.total_routes;
        })
        .catch(error => console.error('Error loading stats:', error));
}

// Auto-hide flash messages
function autoHideFlashes() {
    const flashes = document.querySelectorAll('.flash');
    flashes.forEach(flash => {
        setTimeout(() => {
            flash.style.animation = 'slideOut 0.5s ease';
            setTimeout(() => flash.remove(), 500);
        }, 5000);
    });
}

// Initialize all departments as collapsed
document.addEventListener('DOMContentLoaded', function() {
    const allDepts = document.querySelectorAll('.dept-content');
    allDepts.forEach(dept => {
        dept.style.display = 'none';
    });
    
    // Load statistics
    loadStats();
    
    // Auto-hide flash messages
    autoHideFlashes();
});
</script>

</body>
</html>
